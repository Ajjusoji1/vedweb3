
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stake History</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #0a0a0a;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .card {
      background: #111;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 10px #0ff;
      max-width: 1000px;
      margin: 20px auto;
    }
    h2 {
      color: #0ff;
    }
    .filter-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    select, input[type="number"], button {
      padding: 8px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
    }
    select, input[type="number"] {
      background: #222;
      color: #fff;
      width: 180px;
    }
    button {
      background: #0ff;
      color: #000;
      cursor: pointer;
    }
    button:hover {
      background: #0cc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #333;
      text-align: left;
    }
    th {
      background: #222;
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: #999;
    }
  </style>
</head>
<body>

<!-- üë§ USER SUMMARY -->
<div id="userSummaryCard" class="card">
  <h2>üë§ User Summary</h2>
  <p><strong>Wallet:</strong> <span id="summaryWallet">-</span></p>
  <p><strong>Total Staked:</strong> <span id="summaryTotalStaked">-</span></p>
  <p><strong>Total Rewards:</strong> <span id="summaryTotalRewards">-</span></p>
  <p><strong>Stakes:</strong> <span id="summaryCount">-</span> </p>
</div>

<!-- üìú STAKE HISTORY -->
<div class="card">
  <h2>üìú Stake History</h2>
  <div class="filter-row">
    <select id="filterStatus">
      <option value="all">All Status</option>
      <option value="active">Active</option>
      <option value="completed">Completed</option>
    </select>
    <input type="number" id="minAmount" placeholder="Min Amount" />
    <button id="applyFilters">Apply Filters</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Wallet</th>
        <th>Amount</th>
        <th>Days</th>
        <th>Reward</th>
        <th>Start</th>
        <th>Ends</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="stakeTableBody">
      <tr><td colspan="7">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAvyCHq4NDM4zh2IFhm-NczTNy_WJNxv7w",
    authDomain: "veddev-design.firebaseapp.com",
    databaseURL: "https://veddev-design-default-rtdb.firebaseio.com/",
    projectId: "veddev-design",
    storageBucket: "veddev-design.appspot.com",
    messagingSenderId: "1005840455508",
    appId: "1:1005840455508:web:944c6890fbf82167e55ac1",
    measurementId: "G-JVCYDNDW7L"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  async function loadStakeData(wallet) {
    const tableBody = document.getElementById("stakeTableBody");
    tableBody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";

    const snapshot = await db.ref("stakes").once("value");
    tableBody.innerHTML = "";
    if (!snapshot.exists()) {
      tableBody.innerHTML = "<tr><td colspan='7'>No data</td></tr>";
      return;
    }

    const data = snapshot.val();
    const allStakes = Object.entries(data).map(([id, s]) => ({ ...s, id }));
    const statusFilter = document.getElementById("filterStatus").value;
    const minAmount = parseFloat(document.getElementById("minAmount").value) || 0;

const filtered = allStakes.filter(s => {
      const isCompleted = s.endsAt && Date.now() > s.endsAt;
      const isActive = !isCompleted;
      const matchStatus =
        statusFilter === "all" ||
        (statusFilter === "active" && isActive) ||
        (statusFilter === "completed" && isCompleted);
      return matchStatus && s.amount >= minAmount && s.wallet === wallet;
    });

    if (filtered.length === 0) {
      tableBody.innerHTML = "<tr><td colspan='7'>No results</td></tr>";
      return;
    }

    for (const stake of filtered) {
      const isClaimable = !stake.claimed && Date.now() >= stake.endsAt;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <tr>
          <td>${stake.wallet}</td>
          <td>${stake.amount}</td>
          <td>${stake.days}</td>
          <td>${stake.reward}</td>
          <td>${new Date(stake.createdAt).toLocaleDateString()}</td>
          <td>${new Date(stake.endsAt).toLocaleDateString()}</td>
          <td>
            ${stake.claimed
              ? "‚úÖ Claimed"
              : isClaimable
              ? `<button class="claimBtn" data-id="${stake.id}">Claim</button>`
              : "‚è≥ Not Ready"}
          </td>
        </tr>
      `;
      tableBody.appendChild(tr);
    }

    document.querySelectorAll(".claimBtn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const stakeId = btn.dataset.id;
        btn.textContent = "‚è≥ Claiming...";
        btn.disabled = true;

        try {
          const res = await fetch("https://us-central1-veddev-design.cloudfunctions.net/claimStakeReward", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ stakeId })
          });
          const result = await res.json();
          if (result.success) {
            btn.textContent = "‚úÖ Claimed";
            detectWalletAndLoad(); // reload all
          } else {
            btn.textContent = "‚ùå Error";
            alert(result.message);
          }
        } catch (e) {
          btn.textContent = "‚ùå Error";
          alert("Network error");
        }
      });
    });
  }

  async function loadUserSummary(wallet) {
    const snapshot = await db.ref("stakes").once("value");
    let totalStaked = 0, totalRewards = 0, count = 0, claimed = 0, active = 0;

    snapshot.forEach((childSnap) => {
      const stake = childSnap.val();
      if (stake.wallet === wallet) {
        count++;
        totalStaked += Number(stake.amount);
        totalRewards += Number(stake.reward);
        if (stake.claimed) claimed++;
        if (!stake.claimed && stake.endsAt > Date.now()) active++;
      }
    });

    document.getElementById("summaryWallet").textContent = wallet;
    document.getElementById("summaryTotalStaked").textContent = `${totalStaked} TRX`;
    document.getElementById("summaryTotalRewards").textContent = `${totalRewards} TRX`;
    document.getElementById("summaryCount").textContent = `${count} (${claimed} claimed, ${active} active)`;
  }

  function detectWalletAndLoad() {
    if (window.tronWeb?.defaultAddress?.base58) {
      const wallet = window.tronWeb.defaultAddress.base58;
      loadUserSummary(wallet);
      loadStakeData(wallet);
    } else {
      setTimeout(detectWalletAndLoad, 1000);
    }
  }

  document.getElementById("applyFilters").addEventListener("click", detectWalletAndLoad);
  detectWalletAndLoad();
</script>

<!-- ‚úÖ history.html -->

<!-- Referral Summary UI -->
<div id="referralSummaryCard" class="summary-card">
  <h3>üéÅ Referral Rewards</h3>
  <p id="refTotal">Total Reward: 0 TRX</p>
  <p id="refClaimed">Claimed: 0 TRX</p>
  <p id="refPending">Pending: 0 TRX</p>
  <button id="claimReferralBtn">üí∏ Claim Referral Reward</button>
  <p id="refClaimStatus"></p>
</div>

<!-- Style Suggestion (optional) -->
<style>
  .summary-card {
    background: #111;
    color: #fff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0, 255, 128, 0.5);
  }
  .summary-card button {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: #00ff99;
    color: black;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
</style>

<!-- üë• Referral Reward History Table -->
  <h2>Referral Rewards</h2>
   <table> 
    <thead>
       <tr>
         <th>From (Referral Wallet)</th>
          <th>Stake Amount</th>
           <th>Reward (5%)</th>
            <th>Date</th>
             <th>Status</th> 
            </tr>
          </thead>
           <tbody id="referralTableBody"></tbody>
           </table>
           <!-- üßÆ Filter Referral Rewards -->
<div style="margin-top: 20px;">
  <label for="referralStatusFilter">Filter by Status:</label>
  <select id="referralStatusFilter" onchange="filterReferralRewards()" style="margin-left: 10px;">
    <option value="all">All</option>
    <option value="pending">Pending</option>
    <option value="claimed">Claimed</option>
  </select>
</div>

<script>
  async function loadReferralData(wallet) {
    const tableBody = document.getElementById("referralTableBody");
    tableBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

    const snapshot = await db.ref("referrals").once("value");
    tableBody.innerHTML = "";
    if (!snapshot.exists()) {
      tableBody.innerHTML = "<tr><td colspan='5'>No data</td></tr>";
      return;
    }

    const data = snapshot.val();
    const allReferrals = Object.entries(data).map(([id, r]) => ({ ...r, id }));
    const filtered = allReferrals.filter(r => r.from === wallet);

    if (filtered.length === 0) {
      tableBody.innerHTML = "<tr><td colspan='5'>No results</td></tr>";
      return;
    }

    for (const ref of filtered) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ref.from}</td>
        <td>${ref.stakeAmount} TRX</td>
        <td>${ref.reward} TRX</td>
        <td>${new Date(ref.date).toLocaleDateString()}</td>
        <td>${ref.claimed ? "‚úÖ Claimed" : "‚è≥ Pending"}</td>
      `;
      tableBody.appendChild(tr);
    }
  }

  async function loadReferralSummary(wallet) {
    const snapshot = await db.ref("referralSummary").child(wallet).once("value");
    if (!snapshot.exists()) {
      document.getElementById("refTotal").textContent = "Total Reward: 0 TRX";
      document.getElementById("refClaimed").textContent = "Claimed: 0 TRX";
      document.getElementById("refPending").textContent = "Pending: 0 TRX";
      return;
    }

    const summary = snapshot.val();
    document.getElementById("refTotal").textContent = `Total Reward: ${summary.totalReward} TRX`;
    document.getElementById("refClaimed").textContent = `Claimed: ${summary.claimed} TRX`;
    document.getElementById("refPending").textContent = `Pending: ${summary.pending} TRX`;
  }

  async function claimReferralReward() {
    const wallet = window.tronWeb.defaultAddress
.base58;
    const res = await fetch("https://us-central1-veddev-design.cloudfunctions.net/claimReferralReward", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet })
    });
    const result = await res.json();
    if (result.success) {
      document.getElementById("refClaimStatus").textContent = "‚úÖ Reward Claimed!";
      detectWalletAndLoad();
    } else {
      document.getElementById("refClaimStatus").textContent = `‚ùå Error: ${result.message}`;
    }
  }

  document.getElementById("claimReferralBtn").addEventListener("click", claimReferralReward);

  function detectWalletAndLoad() {
    if (window.tronWeb?.defaultAddress?.base58) {
      const wallet = window.tronWeb.defaultAddress.base58;
      loadReferralSummary(wallet);
      loadReferralData(wallet);
    } else {
      setTimeout(detectWalletAndLoad, 1000);
    }
  }

  detectWalletAndLoad();
</script>

</body>
</html>
